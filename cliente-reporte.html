<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generar Reporte de Falla â€“ CFE</title>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body class="registro-cliente">
  <!-- Fondo animado -->
  <div id="particles-js"></div>

  <!-- Encabezado -->
  <header class="encabezado">
    <img src="img/logo.png" alt="Logo CFE" class="logo-cfe"/>
  </header>

  <!-- Botones navegaciÃ³n -->
  <div style="position:absolute;top:90px;right:40px;z-index:2;display:flex;gap:12px;">
    <a href="cliente-inicio.html"       class="boton-volver">ðŸ”™ Regresar a Inicio</a>
    <a href="cliente-consulta-rep.html" class="boton-volver">ðŸ“‹ Consultar Reporte de Falla</a>
  </div>

  <!-- Panel reporte -->
  <div class="form-container" style="background:#1e1e1e;margin-top:140px;max-width:520px;">
    <h2>Generar Reporte de Falla</h2>

    <form id="form-reporte">
      <label for="tipo">Tipo de Falla:</label>
      <select id="tipo" required>
        <option value="">Seleccione</option>
        <option>ApagÃ³n</option>
        <option>VariaciÃ³n de voltaje</option>
        <option>Corto circuito</option>
      </select>

      <label for="ubicacion">UbicaciÃ³n de la Falla:</label>
      <input id="ubicacion" type="text" placeholder="Calle, nÃºmero, colonia..." required/>

      <label for="observaciones">DescripciÃ³n u Observaciones:</label>
      <textarea id="observaciones" placeholder="Detalles adicionales..." required></textarea>

      <button class="btn" style="margin-top:20px;">Guardar Reporte</button>
    </form>

    <p id="mensaje-exito"
       style="display:none;color:#0f0;margin-top:15px;font-weight:bold;">
      âœ… Reporte guardado correctamente.
    </p>
  </div>

  <!-- PartÃ­culas -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
  <script>
    particlesJS("particles-js",{
      particles:{number:{value:80},color:{value:"#00ff00"},shape:{type:"circle"},
      opacity:{value:.5},size:{value:3},
      line_linked:{enable:true,distance:150,color:"#00ff00",opacity:.4,width:1},
      move:{enable:true,speed:2}},
      interactivity:{events:{onhover:{enable:true,mode:"repulse"}}},
      retina_detect:true
    });
  </script>

  <!-- LÃ³gica de reporte -->
  <script>
    const API     = "http://localhost:3000/api";
    const usuario = JSON.parse(localStorage.getItem("usuario"));

    /* --- Redirigir si no hay sesiÃ³n --- */
    if (!usuario){
      alert("No hay sesiÃ³n. Inicia nuevamente.");
      location.href = "index.html";
    }

    /* --- Referencias DOM --- */
    const form  = document.getElementById("form-reporte");
    const tipo  = document.getElementById("tipo");
    const ubic  = document.getElementById("ubicacion");
    const obs   = document.getElementById("observaciones");
    const msgOK = document.getElementById("mensaje-exito");

    /* --- EnvÃ­o del reporte --- */
    form.addEventListener("submit", async e=>{
      e.preventDefault();

      if (!tipo.value || !ubic.value.trim() || !obs.value.trim()){
        alert("Completa todos los campos");
        return;
      }

      try{
        const res = await fetch(`${API}/reportes`,{
          method : "POST",
          headers: { "Content-Type":"application/json" },
          body   : JSON.stringify({
            id_usuario    : usuario.id_usuario,     // se corrige clave
            tipo_falla    : tipo.value,
            ubicacion     : ubic.value.trim(),
            observaciones : obs.value.trim()        // se corrige nombre
          })
        });

        /* Si el backend responde 204 No Content, no hay JSON */
        let data = {};
        if (res.status !== 204) data = await res.json();

        if (res.ok){
          msgOK.style.display = "block";
          /* guardamos el id del reporte para la pantalla de consulta */
          if (data.id_reporte) {
            localStorage.setItem("id_reporte", data.id_reporte);
          }
          setTimeout(()=> location.href = "cliente-consulta-rep.html", 1400);
        }else{
          alert(data.error || "No se pudo guardar el reporte");
        }
      }catch(err){
        console.error(err);
        alert("Servidor no disponible");
      }
    });
  </script>
</body>
</html>
