<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporte de Falla ‚Äì CFE</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .formulario-reporte {
      max-width: 500px;
      background-color: rgba(20, 20, 20, 0.95);
      padding: 40px;
      border-radius: 20px;
      margin: 80px auto;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
      color: #fff;
      z-index: 2;
      position: relative;
    }
    .formulario-reporte h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .formulario-reporte label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    .formulario-reporte input,
    .formulario-reporte select,
    .formulario-reporte textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-top: 5px;
      background-color: #1a1a1a;
      color: #fff;
    }
    .formulario-reporte input::placeholder,
    .formulario-reporte textarea::placeholder {
      color: #aaa;
    }
    .btn-guardar {
      background-color: #00cc00;
      color: #fff;
      padding: 12px;
      width: 100%;
      margin-top: 30px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn-guardar:hover {
      background-color: #009900;
    }
    .btn-back,
    .btn-consulta {
      position: absolute;
      top: 90px;
      right: 30px;
      background: #2d2d2d;
      color: white;
      padding: 10px 20px;
      border-radius: 30px;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
      box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
      z-index: 3;
    }
    .btn-consulta {
      right: 210px;
    }
    .btn-back:hover,
    .btn-consulta:hover {
      background: #1a1a1a;
    }
  </style>
</head>

<body class="registro-cliente">
  <!-- Fondo animado -->
  <div id="particles-js"></div>

  <!-- Encabezado -->
  <header class="encabezado">
    <img src="img/logo.png" alt="Logo CFE" class="logo-cfe" />
  </header>

  <!-- Botones -->
  <a href="cliente-inicio.html" class="btn-back">‚¨ÖÔ∏è Regresar a Inicio</a>
  <a href="cliente-consulta-rep.html" class="btn-consulta">üìã Consultar Reporte de Falla</a>

  <!-- Formulario -->
  <form id="form-reporte" class="formulario-reporte">
    <h2>Generar Reporte de Falla</h2>

    <label for="tipo_falla">Tipo de Falla:</label>
    <select name="tipo_falla" id="tipo_falla" required>
      <option value="Apag√≥n">Apag√≥n</option>
      <option value="Variaci√≥n de voltaje">Variaci√≥n de voltaje</option>
      <option value="Corto circuito">Corto circuito</option>
    </select>

    <label for="calle">Calle:</label>
    <input type="text" id="calle" name="calle" placeholder="Ej. Benito Ju√°rez" required />

    <label for="numero">N√∫mero:</label>
    <input type="text" id="numero" name="numero" placeholder="Ej. 18A" required />

    <label for="colonia">Colonia:</label>
    <input type="text" id="colonia" name="colonia" placeholder="Ej. Centro" required />

    <label for="municipio">Municipio:</label>
    <input type="text" id="municipio" name="municipio" placeholder="Ej. Xalapa" required />

    <label for="codigo_postal">C√≥digo Postal:</label>
    <input type="text" id="codigo_postal" name="codigo_postal" placeholder="Ej. 91000" required />

    <label for="referencias">Referencias Adicionales:</label>
    <input type="text" id="referencias" name="referencias" placeholder="Frente a parque, cerca de tienda..." />

    <label for="descripcion">Descripci√≥n u Observaciones:</label>
    <textarea id="descripcion" name="descripcion" placeholder="Detalles adicionales..." rows="4"></textarea>

    <button type="submit" class="btn-guardar">Guardar Reporte</button>
  </form>

  <!-- Fondo animado -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
  <script>
    particlesJS("particles-js", {
      particles: {
        number: { value: 80 },
        color: { value: "#00ff00" },
        shape: { type: "circle" },
        opacity: { value: 0.5 },
        size: { value: 3 },
        line_linked: {
          enable: true,
          distance: 150,
          color: "#00ff00",
          opacity: 0.4,
          width: 1
        },
        move: { enable: true, speed: 2 }
      },
      interactivity: {
        events: {
          onhover: { enable: true, mode: "repulse" }
        }
      },
      retina_detect: true
    });
  </script>

  <!-- JS para enviar reporte -->
  <script>
    const API = "http://localhost:3000/api";

    document.getElementById("form-reporte").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;

      const tipo_falla = form.tipo_falla.value;
      const calle = form.calle.value.trim();
      const numero = form.numero.value.trim();
      const colonia = form.colonia.value.trim();
      const municipio = form.municipio.value.trim();
      const codigo_postal = form.codigo_postal.value.trim();
      const referencias = form.referencias.value.trim();
      const descripcion = form.descripcion.value.trim();

      if (!tipo_falla || !calle || !numero || !colonia || !municipio || !codigo_postal) {
        alert("Por favor, llena todos los campos obligatorios.");
        return;
      }

      const usuario = JSON.parse(localStorage.getItem("usuario"));
      if (!usuario || !usuario.id_usuario) {
        alert("No se ha iniciado sesi√≥n.");
        return;
      }

      try {
        const res = await fetch(`${API}/reportes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id_usuario: usuario.id_usuario,
            tipo_falla,
            calle,
            numero,
            colonia,
            municipio,
            codigo_postal,
            referencias,
            descripcion
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert(`‚úÖ Reporte generado con √©xito. Folio: ${data.folio}`);
          form.reset();
        } else {
          alert(data.error || "Error al generar reporte.");
        }
      } catch (err) {
        console.error(err);
        alert("No se pudo conectar con el servidor.");
      }
    });
  </script>
</body>
</html>
