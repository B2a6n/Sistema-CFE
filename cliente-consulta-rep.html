<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Seguimiento del Reporte ‚Äì CFE</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body class="registro-cliente">

  <!-- Fondo animado ----------------------------------------------------->
  <div id="particles-js"></div>

  <!-- Encabezado -------------------------------------------------------->
  <header class="encabezado">
    <img src="img/logo.png" alt="Logo CFE" class="logo-cfe" />
  </header>

  <!-- Bot√≥n volver ------------------------------------------------------>
  <a href="cliente-inicio.html" class="btn-regresar">Regresar a Inicio</a>

  <!-- Panel ------------------------------------------------------------->
  <section class="progreso-reporte" style="position:relative;z-index:2;color:#fff">
    <h2 style="text-align:center">Seguimiento del Reporte</h2>

    <article id="estado-envio">
      <h3>Reporte Enviado</h3>
      <small id="fecha-envio"></small>
      <p>Tu reporte fue enviado correctamente y est√° esperando revisi√≥n.</p>

      <div id="aviso-estatus" style="padding:6px 10px;border-radius:6px"></div>
    </article>

    <hr style="border-color:#0f0;margin:30px 0" />

    <h3 style="color:#0f0">Detalles del Reporte</h3>
    <ul id="detalle-reporte" style="line-height:1.6"></ul>
  </section>

  <!-- Part√≠culas -------------------------------------------------------->
  <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
  <script>
    particlesJS("particles-js",{
      particles:{number:{value:80},color:{value:"#00ff00"},shape:{type:"circle"},
      opacity:{value:0.5},size:{value:3},
      line_linked:{enable:true,distance:150,color:"#00ff00",opacity:0.4,width:1},
      move:{enable:true,speed:2}},
      interactivity:{events:{onhover:{enable:true,mode:"repulse"}}},
      retina_detect:true
    });
  </script>

  <!-- L√≥gica ------------------------------------------------------------>
  <script>
  (async ()=>{
    /* ---------- Config ---------- */
    const API      = "http://localhost:3000/api";
    const idReporte= localStorage.getItem("id_reporte");   // lo guardamos al crear
    const detalle  = document.getElementById("detalle-reporte");
    const fechaTxt = document.getElementById("fecha-envio");
    const avisoBox = document.getElementById("aviso-estatus");

    if(!idReporte){
      detalle.innerHTML = "<li>No se encontr√≥ ning√∫n folio en el navegador.</li>";
      return;
    }

    /* ---------- funci√≥n que pinta todo ---------- */
    function pinta(data){
      fechaTxt.textContent = `üìÖ ${ new Date(data.fecha_reporte)
                                   .toLocaleString('es-MX',{dateStyle:'medium',
                                                             timeStyle:'short'}) }`;
      detalle.innerHTML = `
        <li><strong>Tipo de Falla:</strong> ${data.tipo_falla}</li>
        <li><strong>Ubicaci√≥n:</strong> ${data.ubicacion}</li>
        <li><strong>Observaciones:</strong> ${data.descripcion}</li>
        <li><strong>Estado Actual:</strong> <span id="estado-actual">${data.estatus}</span></li>`;
      avisoBox.textContent = `Estado actual: ${data.estatus}`;
      setColor(avisoBox, data.estatus);
    }

    /* ---------- obtener datos iniciales ---------- */
    async function cargaInicial(){
      const r = await fetch(`${API}/reportes/${idReporte}`);
      if(!r.ok) throw new Error("Reporte no encontrado");
      const d = await r.json();
      pinta(d);
      return d.estatus;          // devolvemos estatus para comparar despu√©s
    }

    /* ---------- monitoreo de cambios ---------- */
    let ultimoEstatus;
    try{ ultimoEstatus = await cargaInicial(); }
    catch(err){ detalle.innerHTML = `<li>Error: ${err}</li>`; return; }

    setInterval(async ()=>{
      try{
        const r  = await fetch(`${API}/reportes/${idReporte}/estatus`);
        if(!r.ok) return;                      // si falla, lo ignoramos
        const d2 = await r.json();
        if(d2.estatus !== ultimoEstatus){
          ultimoEstatus = d2.estatus;
          document.getElementById("estado-actual").textContent = d2.estatus;
          avisoBox.textContent = `Estado actual: ${d2.estatus}`;
          setColor(avisoBox, d2.estatus);
        }
      }catch{}
    }, 30000);      // cada 30 s

    /* ---------- color helper ---------- */
    function setColor(el, est){
      const colores = {
        "Pendiente":  "#ffaa00",
        "En revisi√≥n":"#ff7300",
        "Atendiendo": "#0099ff",
        "Finalizado": "#00cc66"
      };
      el.style.background = colores[est] || "#00ff00";
    }
  })();
  </script>
</body>
</html>
